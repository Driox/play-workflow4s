# Pre-requisites

## DB

Setup a Postgres DB with the following credentials:

- user: app
- password: app
- database: app-test-db


# Documetation

## 01-Core

This module mainly wire ZIO with Play using `Action.zio`

```scala
def home() = Action.zio { implicit req =>
  ZIO.succeed(Ok(views.html.index()))
}
```

We also standardize the error channel with `Fail` and allow to use the `?|` operator to convert a lot of type (Either, Option, Future, etc...) into ZIO

```scala
for {
  user <- user_repo.findById(uuid)            ?| "User not found"     // findById       return Future[Option[User]]
  adr  <- address_repo.findByUserId(user.id)  ?| "Address not found"  // findByUserId   return Future[Either[Fail, Address]]
  result <- compute_result(user, adr)                                 // compute_result return ZIO[Any, Fail, Result]
} yield {
  result
}
```

Read [this](https://medium.com/@adriencrovetto/error-handling-in-scala-with-play-framework-130034b21b37) for more details. It's a bit old (scalaz instead of zio) but it's still relevant.

## 02-Workflow4s-zio

This module is a reimplementation of the [`workflow4s-doobie`](https://github.com/business4s/workflows4s/tree/main/workflows4s-doobie) module using ZIO + Anorm instead of Cats + Doobie.
All public interface return ZIO type instead of Cats type, you can see it in `modules/02-workflow4s-zio/src/WorkflowStorage.scala` or `modules/02-workflow4s-zio/src/DatabaseRuntime.scala`

This is based on release `v0.1.2` of `workflow4s` so it doesn't support Workflow Registry yet.

## Main Play App

Our sample Workflow simulate a KYC process in `app/workflow/domain/KycWorkflow.scala`.
The KycModel and KycStatus are generated by LLM.
You can run the workflow in memory in `test/KycWorkflowTest.scala` with `sbt testOnly workflows.KycWorkflowTest`


The Play Controller exposes 3 endpoints:

- `create_kyc`: create a new workflow instance and deliver a signal to it
- `update_data`: update the workflow instance with some data
- `render`: render the workflow instance

You can start with this url `http://localhost:9000/kyc/create/usr-0001`

You can switch implem in `app/controllers/WorkflowController.scala` between `ZioDbRuntime` and `ZioWrapperDbRuntime` by toggling the import / DI

```
// import for Zio implem i.e. ZioDbRuntime
import _root_.workflow.runtime.ZioDbRuntime
import workflows4s.anorm.postgres.WorkflowId

// import for Cat's Wrapper i.e. ZioWrapperDbRuntime
import _root_.workflow.runtime.ZioWrapperDbRuntime
import workflows4s.doobie.postgres.WorkflowId
```
